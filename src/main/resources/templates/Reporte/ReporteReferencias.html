<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>

	<head th:replace="combo/head.html :: head"></head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<link rel="stylesheet" type="text/css" th:href="@{/styles/login.css}">
	<link rel="stylesheet" type="text/css" th:href="@{/styles/General.css}">
	<link rel="stylesheet" type="text/css" th:href="@{/styles/fuenteColor.css}">
	<link rel="stylesheet" type="text/css" th:href="@{/styles/NavBar.css}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
	<title> MARKETING</title>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>
	<header th:replace="combo/navBar.html :: navbar"></header>
	<!-- Encabezado general -->
	<!-- Encabezado general -->
	<div class="containerFlex" id="encabezado" >
		<div class="local">
			<h2 class="letraBlue" th:replace="combo/comboLocal.html :: comboLocal"></h2>
		</div>

		<div class="descripcion">
			<h2 class="tituloAFcenter">LISTA REFERENCIAS</h2>
		</div>
		<div class="fechahora">
			<h2 class="letra" th:replace="combo/FechaHoraActual.html :: comboFechaHora">

		</div>

	</div>
	
	 <div style="display: flex; justify-content: flex-end; margin-right: 100px; margin-top: 20px; margin-bottom: 25px; align-items: center; gap: 10px;">
        <span style="font-weight: bold;">Exportar:</span>
    
         <!-- Botón PDF -->
         <button onclick="GenerarReporte('PDF')" style="border: none; background: none; cursor: pointer;">
          <img src="./imagenes/logoPDF.png" alt="PDF" title="Exportar a PDF" width="45">
         </button>

         <!-- Botón Excel -->
        <button onclick="GenerarReporte('EXCEL')" style="border: none; background: none; cursor: pointer;">
          <img src="./imagenes/logoEXCEL.png" alt="Excel" title="Exportar a Excel" width="45">
         </button>
       </div>
       

	<form class="containerTable">


		<!-- Registros Terceros -->
		<div class="form-group">

			<table class="table">
				<thead>

					<tr>

						<th></th>
						<th class="subtituloCentrado">PLU</th>
						<th class="subtituloAF">REFERENCIA</th>
						<th class="subtituloAF">ID-ESTRATO</th>
						<th class="subtituloAF">V.L#1</th>
						<th class="subtituloAF">CTA FACTURA DEBITO</th>
						<th class="subtituloAF">CTA FACTURA CREDITO</th>
						<th class="subtituloAF">CTA RECAUDO DEBITO</th>
						<th class="subtituloAF">CTA RECAUDO CREDITO</th>

					</tr>
				</thead>
				<tbody>

					<tr th:each="referencia : ${TodasLasReferencias}">
						<td class="detalleCentrado" text=""></td>
						<td class="detalleCentrado" th:text="${referencia.getIDPLU()}"></td>
						<td>
							<a href="#" th:text="${referencia.getNombrePlu()}"
								th:onclick="'mostrarDetalle(\'' + ${referencia.getIDPLU()} + '\')'"></a>
						</td>
						<td class="detalleAF" th:text="${referencia.getIdEstracto()}"></td>
						<td class="detalleAF" th:text="${referencia.getVrGeneral()}"></td>
						<td class="detalleAF" th:text="${referencia.cuentaContableDebito == null 
                                                       or #strings.isEmpty(#strings.trim(referencia.cuentaContableDebito))
                                                       or referencia.cuentaContableDebito == ' '
                                                       or referencia.cuentaContableDebito == 'NULL'
      												   or referencia.cuentaContableDebito == 'null'
                                                       or referencia.cuentaContableDebito == '0'}
                                                       ? 'Sin asignar'
                                                       : ${referencia.getCuentaContableDebito()}">
						</td>
						<td class="detalleAF" th:text="${referencia.cuentaContableCredito == null 
                                                       or #strings.isEmpty(referencia.cuentaContableDebito)
                                                       or referencia.cuentaContableDebito == 'NULL'
      												   or referencia.cuentaContableDebito == 'null'
                                                       or referencia.cuentaContableDebito == '0'}
                                                       ? 'Sin asignar'
                                                       : ${referencia.getCuentaContableCredito()}">
						</td>
						<td class="detalleAF" th:text="${referencia.cuentaRecaudoDebito == null 
                                                       or #strings.isEmpty(referencia.cuentaContableDebito)
                                                       or referencia.cuentaContableDebito == 'NULL'
      												   or referencia.cuentaContableDebito == 'null'
                                                       or referencia.cuentaContableDebito == '0'}
                                                       ? 'Sin asignar'
                                                       : ${referencia.getCuentaRecaudoDebito()}">
						</td>
						<td class="detalleAF" th:text="${referencia.cuentaRecaudoCredito == null 
                                                       or #strings.isEmpty(referencia.cuentaContableDebito)
                                                       or referencia.cuentaContableDebito == 'NULL'
      												   or referencia.cuentaContableDebito == 'null'
                                                       or referencia.cuentaContableDebito == '0'}
                                                       ? 'Sin asignar'
                                                       : ${referencia.getCuentaRecaudoCredito()}">
						</td>
					</tr>
				</tbody>
			</table>
		</div>

	</form>
	<div>
		<a href="./Referencia" class="btn btn-success" style="margin: 50px;">Regresar</a>

	</div>
	
	<div id="loadingSpinner" style="display: none;">
   				 
  	   <div class="spinner"></div>
	</div>









	<script th:inline="javascript" src="./js/contadorRegresivo.js"></script>
	<script th:inline="javascript">

		function GenerarReporte(formato) {
	
	   event.preventDefault();
	   

       // Mostrar el spinner de carga
       document.getElementById('loadingSpinner').style.display = 'block';
         


        // Crear un objeto que contenga los datos a enviar
		var datos = {
			formato: formato
			};

		 // Realizar una solicitud POST al controlador
		 fetch("./DescargarReporteReferencias", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify(datos),
		})
		.then(response => {
     if (!response.ok) {
          throw new Error('Network response was not ok');
      }
      return response.blob();  // Convierte la respuesta a un Blob (secuencia de bytes)
   })
  .then(blob => {
     const url = window.URL.createObjectURL(blob);
        
     if (formato === 'PDF') {
        // Abrir el PDF en una nueva pestaña
        window.open(url, '_blank');
      } else if (formato === 'EXCEL') {
         // Descargar el archivo Excel
         const a = document.createElement('a');
         a.href = url;
         a.download = 'reporte.xlsx';
         document.body.appendChild(a);
         a.click();
         a.remove();
       }

      // Liberar la URL del objeto para liberar recursos
      window.URL.revokeObjectURL(url);
   })
   .catch(error => console.error('Error al descargar el archivo', error))
   .finally(() => {
      // Ocultar el spinner de carga
      document.getElementById('loadingSpinner').style.display = 'none';
      button.disabled = false;
  });
  
 }



	</script>
</body>

</html>