<html xmlns:th="http://www.thymeleaf.org">
<head>
 	<head th:replace ="combo/head.html :: head" ></head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" th:href="@{/styles/login.css}">
        <link rel="stylesheet" type="text/css" th:href="@{/styles/General.css}"> 
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/fuenteColor.css}"> 
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/NavBar.css}"> 
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/ComprobanteContable.css}">
        <title> MARKETING</title>
</head>
<body class="colorbody">
    <header th:replace="combo/navBar.html :: navbar"></header>
    
    	<div class="containerFlex" id="encabezado">
		<div class="local">
			<h2 class="letraBlue" th:replace="combo/comboLocal.html :: comboLocal"></h2>
		</div>
	
		<div class="descripcion"> 
			<h2 class="tituloAFcenter">ORDEN DE TRABAJO</h2>
		</div>
		<div class="fechahora">
			<h2 class="letra" th:replace="combo/FechaHoraActual.html :: comboFechaHora">
				
		</div>
		
	</div>
    <div  >
        
        	    <!-- Formulario para seleccionar formato y enviar datos -->
	<form  method="post" id="formReporte">
		<div >
			<div >
				<div class="containerFlexCenter">
				
				
					<div>
						<label class="letra" for="PeriodoCobro">PERIODO ACTUAL</label>
						<br>
							<input type="text" maxlength="5" id="PeriodoCobro" name="PeriodoCobro" style="width: 220px;" th:attr="valor=${xIdPeriodo}"  th:value="${xIdPeriodo + ' - ' + xINombrePeriodo}" readonly>
							<input type="hidden" name="xIdPeriodo" id="xIdPeriodo" th:value="${xIdPeriodo}" />
					</div>
						
					<div>
						<label class="letra" for="FechaFinal">OPERARIOS</label>
						<br>
						<select name="operario" id="operario" style="width: 128px; margin-left: 5px;">
								<option selected disabled>-Seleccione-</option>
								<option th:text="${xOperario.getNombreUsuario()}" th:each="xOperario:${operarios}"
									th:value="${xOperario.getIdUsuario()}" ></option>
							</select>
					</div>
					
					
					
					
					
					<div>
						
							<label class="letra">TERCERO</label>
						<br>
						<div class="search-container" style="width: 300px;">
							<input type="text" placeholder="Buscar" id="buscarTercero" onfocus="BuscarTerceros(1)" autocomplete="off">
							<div class="results-container" id="terceros" style="height: 200px;"></div>
						</div>
					</div>

					
					<div>
						<label class="letra" for="FechaFinal">OBSERVACION</label>
						<br>
						<textarea  id="Observacion" name="Observacion" maxlength="500" style="width: 550px;"></textarea>
					</div>
	
	
					

	
				</div>
				
				
							<div class="tablaContable">
		 <table id="tabla">
        <thead>
            <tr>
                <th>#</th>
                <th>DESCRIPCION</th>
                <th>VR.UNITARIO</th>
                <th>%IVA</th>
                <th>CANTIDAD</th>
                <th>VR.SUBTOTAL</th>
                <th>EXISTENCIA</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>

                <td>
                    <div class="search-container">
                            <input type="text" placeholder="Buscar" id="buscarCuenta" onfocus="BuscarCuentas(1)" autocomplete="off">
                            <span class="icon">üîç</span>
                            <div class="results-container" id="results" style="height: 200px;"></div>
                      </div>
                </td>

                <td>
					<input type="text" id="vrUnitario" readonly>
                </td>
                <td>
					<input type="text" style="width: 120px;" id="iva" readonly>
				</td>
                <td>
					<input type="number" value="0.00" style="width: 80px;" id="cantidad1" oninput="actualizarSubtotal(1)">
				</td>
				
				 <td>
					<input type="text" style="width: 120px;" id="vrSubTotal1" readonly>
				</td>
				
				<td>
					<input type="number" value="0.00"  style="width: 80px;" id="existencia1" readonly>
				</td>

				<td>
                  <div class="credito-container">
                   <span class="icon save-icon" style="margin-left: 8px;" onclick="agregarFila()">
					   <i class="fas fa-save" ></i>
				   </span>
                   <span class="icon delete-icon" style="margin-left: 8px;">
					   <i class="fas fa-trash-alt"></i>
				   </span>
                 </div>
               </td>
            </tr>
        </tbody>
    </table>
    
    <div class="totals-row" style="margin-right: 100px;">
        <div class="empty-space"></div>
        <div class="totales">
		   <div class="total-debito">
			<strong>Total:</strong> 
		  </div>
		  <div class="total-debito">
			<span id="ventaTotal">0.00</span>
		  </div>
		  <div class="total-debito">
			<span id="totalCreditoResumen"></span>
		  </div>
		  <div class="total-debito">
			<span id="totalCreditoResumen"></span>
		  </div>
			
		</div>

    </div>

		
	</div>
				
				
				
				
				
				<div class="GenerarReporte">

					<button type="button" class="btn btn-info" id="consultarBtn" value="ConfirmarPqr" onclick="GuardarOrdenDeTrabajo()" style="margin-bottom: 50px; ">Generar orden de trabajo</button>
			 </div>
			 <div id="loadingSpinner" style="display: none;">
   				 
  				  <div class="spinner"></div>
			</div>
			
			</div>
		</div>
		
		
		
		
		<div >
			<div >
				<div class="containerFlexCenter">
				
				
					<div>
						<label class="letra" for="PeriodoCobro">PERIODO</label>
						<br>
							<select name="PeriodoCobro" id="PeriodoReporte" style="width: 280px;">
								
								<option th:text="${xLista.getNombrePeriodo()}" th:each="xLista:${xPeriodos}"
									th:value="${xLista.getIdPeriodo()}" th:selected="${xLista.getIdPeriodo() == xIdPeriodo}"></option>
							</select>
					</div>
					
					
					<div>
					<label class="letra">DESTINACION:</label>
					<!-- Select para seleccionar entre "pantalla" o "Archivo" -->
					<select name="formato" id="formato" class="form-select">
						<option value="PDF">Pantalla</option>
						<option value="EXCEL">Archivo</option>
					</select>
					</div>
						
			
					

	
				</div>
				
				<div class="GenerarReporte">
					<a href="./menuPrincipal" class="btn btn-success" style="margin-bottom: 50px; ">Regresar</a>
					<button type="button" class="btn btn-info" id="consultarBtn" value="ConfirmarPqr" onclick="ReporteDetalleOrdenDeTrabajo()" style="margin-bottom: 50px; margin-left: 50px;">Generar Reporte</button>
			 </div>
			 <div id="loadingSpinner" style="display: none;">
   				 
  				  <div class="spinner"></div>
			</div>
			
			</div>
		</div>
	</form>

    </div>
    <script th:inline="javascript" src="./js/contadorRegresivo.js"></script>  
    <script th:inline="javascript">
		
// ‚úÖ Calcula subtotal de una fila seg√∫n su n√∫mero din√°mico
function actualizarSubtotal(filaNum) {
  // Detectar los IDs din√°micos
  let idVrUnitario = filaNum === 1 ? "vrUnitario" : `vrUnitario${filaNum}`;
  let idCantidad   = filaNum === 1 ? "cantidad1"   : `cantidad${filaNum}`;
  let idSubTotal   = filaNum === 1 ? "vrSubTotal1" : `vrSubTotal${filaNum}`;
  let idExistencia = filaNum === 1 ? "existencia1" : `existencia${filaNum}`;

  // Obtener valores
  let vrUnitario = parseFloat(document.getElementById(idVrUnitario)?.value || 0);
  let cantidadInput = document.getElementById(idCantidad);
  let existencia = parseFloat(document.getElementById(idExistencia)?.value || 0);
  let cantidad = parseFloat(cantidadInput?.value || 0);
  
  console.log("existencia es --- " + existencia);
  console.log("cantidad es --- " + cantidad);

  // ‚úÖ Validar que la cantidad no supere la existencia
 /* if (cantidad > existencia) {
    alert(`‚ö†Ô∏è No puede vender ${cantidad} unidades. Solo hay ${existencia} disponibles.`);
    cantidad = existencia;
    cantidadInput.value = existencia; // Corrige el valor autom√°ticamente
  }*/

  // Calcular el subtotal
  let subtotal = vrUnitario * cantidad;
  let campoSubtotal = document.getElementById(idSubTotal);
  if (campoSubtotal) campoSubtotal.value = subtotal.toFixed(2);

  // Recalcular total general
  calcularTotalGeneral();
}

// ‚úÖ Recalcula el total general de todos los subtotales
function calcularTotalGeneral() {
  let total = 0;

  // Suma todos los subtotales existentes (din√°micos e inicial)
  document.querySelectorAll("input[id^='vrSubTotal']").forEach(input => {
    total += parseFloat(input.value || 0);
  });

  let totalResumen = document.getElementById("ventaTotal");
  if (totalResumen) totalResumen.textContent = total.toFixed(2);
}
		
		
		
		
		
		
		
		
let listaCuentas = []; // Almacena todas las cuentas 
let listaTerceros = [];

// Resstablecer valores
 function restablecerValor(input) {
    if (input.value < 0 || input.value === "") {
        input.value = "0.00"; // Restablecer a 0 si el valor es negativo o vac√≠o
    }
}

// Cerrar el dropdown si se hace clic fuera
document.addEventListener("click", function(event) {
    // Selecciona todos los inputs y contenedores de b√∫squeda
    document.querySelectorAll("input[id^='buscarCuenta']").forEach(inputCuenta => {
        let fila = inputCuenta.id.replace("buscarCuenta", ""); // Obtiene el n√∫mero de fila
        let resultsContainer = document.getElementById(fila ? `results${fila}` : "results");

        if (resultsContainer && !inputCuenta.contains(event.target) && !resultsContainer.contains(event.target)) {
            resultsContainer.style.display = "none";
        }
    });

    document.querySelectorAll("input[id^='buscarTercero']").forEach(inputTercero => {
        let fila = inputTercero.id.replace("buscarTercero", ""); // Obtiene el n√∫mero de fila
        let tercerosContainer = document.getElementById(fila ? `terceros${fila}` : "terceros");

        if (tercerosContainer && !inputTercero.contains(event.target) && !tercerosContainer.contains(event.target)) {
            tercerosContainer.style.display = "none";
        }
    });
});

function agregarFila() {
	
	var tablaContable = document.querySelector("#tabla tbody");

    // Filas de la tabla
    var filas = tablaContable.querySelectorAll("tr");  
    var xDetalleContableArr = [];
    var xTerceroArrAtribute = [];
    

    // Iterar sobre cada fila de la tabla
    filas.forEach(function(fila) {
        var elementos = fila.querySelectorAll("td");

        var terceroAtrr = elementos[2].querySelector("input").getAttribute("data-idTercero") || "";
        var detalleContable = elementos[3].querySelector("input").value.trim();
        console.log("terceroAtrr: " + terceroAtrr);
        console.log("detalleContable: " + detalleContable);


        xTerceroArrAtribute.push(terceroAtrr);
        xDetalleContableArr.push(detalleContable);

    });



    
    
    let detalle = xDetalleContableArr[0];
    console.log("detalle: " + detalle);
    
    let idClienteAtrr = xTerceroArrAtribute[0];
    console.log("idClienteAtrr: " + idClienteAtrr);

	
	//------------------------------
    let tabla = document.querySelector(".tablaContable tbody");
    let nuevaFila = document.createElement("tr");
    
    // Contamos cu√°ntas filas hay en la tabla (para asignar el n√∫mero correcto)
    let numFila = tabla.rows.length + 1;

    nuevaFila.innerHTML = `
        <td>${numFila}</td>

				
        <td>
            <div class="search-container">
                <input type="text" placeholder="Buscar" id="buscarCuenta${numFila}" onfocus="BuscarCuentas(${numFila})" autocomplete="off">
                <span class="icon">üîç</span>
                <div class="results-container" id="results${numFila}" style="height: 200px;"></div>
            </div>
        </td>
        
        <td>
		   <input type="text" id="vrUnitario${numFila}" readonly>
        </td>
        <td>
			<input type="text" style="width: 120px;"  id="iva${numFila}" readonly>
		</td>
        <td>
			<input type="number" value="0.00" style="width: 80px;" id="cantidad${numFila}" oninput="actualizarSubtotal(${numFila})">
		</td>				
		 <td>
		    <input type="text" style="width: 120px;" id="vrSubTotal${numFila}" readonly>
		 </td>
		 
		 <td>
			<input type="number" value="0.00" style="width: 80px;" id="existencia${numFila}" readonly>
		 </td>

        <td>
            <div class="credito-container">
                <span class="icon save-icon" style="margin-left: 8px;" onclick="agregarFila()">
                    <i class="fas fa-save"></i>
                </span>
                <span class="icon delete-icon" style="margin-left: 8px;" onclick="eliminarFila(this)">
                    <i class="fas fa-trash-alt"></i>
                </span>
            </div>
        </td>
    `;

    tabla.appendChild(nuevaFila);
    
    // A√±adir el event listener para los nuevos inputs de b√∫squeda de cuenta
    const inputCuentaNuevo = nuevaFila.querySelector(`#buscarCuenta${numFila}`);
    inputCuentaNuevo.addEventListener("input", function() {
        let fila = this.closest('tr').rowIndex; // Obt√©n el n√∫mero de fila din√°micamente
        let filtro = this.value.toLowerCase();
        let cuentasFiltradas = listaCuentas.filter(cuenta =>
            `${cuenta.idCuentaAux} - ${cuenta.nombreCuenta}`.toLowerCase().includes(filtro)
        );
        mostrarCuentas(cuentasFiltradas, fila); // Pasa el n√∫mero de fila
    });
    
    
    // Ejecutar la funci√≥n al cargar la p√°gina
    calcularTotales();
}

// Actualizaci√≥n de las funciones para recibir un par√°metro din√°mico (n√∫mero de fila)
function BuscarCuentas(fila) {
    console.log(`Ingres√≥ a BuscarCuentas en fila ${fila}`);

    fetch("./ObtenerCuentas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        listaCuentas = data.xlistaCuentas; 
        mostrarCuentas(listaCuentas, fila); // Pasamos la fila para saber d√≥nde actualizar
    })
    .catch(error => console.error("Error al obtener cuentas:", error));
}

function mostrarCuentas(cuentas, fila) {
    console.log(`Fila en mostrarCuentas es ${fila}`);

    // Si es la primera fila, usa los IDs sin n√∫mero
    let resultsContainer = fila === 1 ? document.getElementById("results") : document.getElementById(`results${fila}`);
    let inputCuenta = fila === 1 ? document.getElementById("buscarCuenta") : document.getElementById(`buscarCuenta${fila}`);
    let inputVrUnitario = fila === 1 ? document.getElementById("vrUnitario") : document.getElementById(`vrUnitario${fila}`);
    let inputIva = fila === 1 ? document.getElementById("iva") : document.getElementById(`iva${fila}`);
    let inputExistencia = fila === 1 ? document.getElementById("existencia1") : document.getElementById(`existencia${fila}`);

    resultsContainer.innerHTML = "";

    if (cuentas.length === 0) {
        resultsContainer.style.display = "none";
        return;
    }

    cuentas.forEach(cuenta => {
        let item = document.createElement("div");
        item.classList.add("result-item");
        item.textContent = `${cuenta.idPlu} - ${cuenta.nombrePlu}`;
        item.onclick = () => {
            inputCuenta.value = `${cuenta.idPlu} - ${cuenta.nombrePlu}`;
            inputCuenta.setAttribute("data-idCuenta", cuenta.idPlu);
            inputVrUnitario.value = `${cuenta.vrGeneral}`;
            inputIva.value = `${cuenta.porcentajeIva}`;
            inputExistencia.value = `${cuenta.existencia}`;
            
            resultsContainer.style.display = "none";
        };
        resultsContainer.appendChild(item);
    });

    resultsContainer.style.display = "block";
    
    enableKeyboardNavigation(inputCuenta, resultsContainer);
}

// Misma l√≥gica aplicada a `BuscarTerceros`
function BuscarTerceros(fila) {
    console.log(`Ingres√≥ a BuscarTerceros en fila ${fila}`);

    fetch("./ObtenerTerceros", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        listaTerceros = data.xListaTerceros; 
        mostrarTerceros(listaTerceros, fila);
    })
    .catch(error => console.error("Error al obtener terceros:", error));
}

function mostrarTerceros(terceros, fila) {
	console.log(`Fila en mostrarTerceros es ${fila}`);
  //  let resultsContainer = document.getElementById(`terceros${fila}`);
    
    
    // Si es la primera fila, usa los IDs sin n√∫mero
    let resultsContainer = fila === 1 ? document.getElementById("terceros") : document.getElementById(`terceros${fila}`);
    let inputTercero = fila === 1 ? document.getElementById("buscarTercero") : document.getElementById(`buscarTercero${fila}`);

    resultsContainer.innerHTML = "";
    
    if (terceros.length === 0) {
        resultsContainer.style.display = "none";
        return;
    }

    terceros.forEach(tercero => {
        let item = document.createElement("div");
        item.classList.add("result-item");
        item.textContent = `${tercero.cc_Nit} - ${tercero.nombreTercero}`;
        item.onclick = () => {
            inputTercero.value = `${tercero.cc_Nit} - ${tercero.nombreTercero}`;
            inputTercero.setAttribute("data-idTercero", tercero.cc_Nit);
            console.log("CC_NIT esssss" + tercero.cc_Nit );
            
            resultsContainer.style.display = "none";
        };
        resultsContainer.appendChild(item);
    });

    resultsContainer.style.display = "block";
}

// Funci√≥n para eliminar filas din√°micamente
function eliminarFila(elemento) {
    let fila = elemento.closest("tr");
    fila.remove();

    // Recalcular los n√∫meros de fila despu√©s de eliminar
    let filas = document.querySelectorAll(".tablaContable tbody tr");
    filas.forEach((fila, index) => {
        fila.children[0].textContent = index + 1;
    });
}


//--------------------------------- PERMITE NAVEGAR EN LOS RESULTADOS DEL DIV QUE MUESTRA LAS CUENTAS BUSCADAS

function enableKeyboardNavigation(input, container) {
    let currentIndex = -1;

    input.addEventListener("keydown", function (e) {
        const items = container.querySelectorAll(".result-item");

        if (e.key === "ArrowDown") {
            e.preventDefault();
            if (currentIndex < items.length - 1) {
                currentIndex++;
                updateHighlight(items, currentIndex);
            }
        } else if (e.key === "ArrowUp") {
            e.preventDefault();
            if (currentIndex > 0) {
                currentIndex--;
                updateHighlight(items, currentIndex);
            }
        } else if (e.key === "Enter") {
            e.preventDefault();
            if (currentIndex >= 0 && currentIndex < items.length) {
                items[currentIndex].click(); // simula clic
                currentIndex = -1; // reinicia
            }
        }
    });

    function updateHighlight(items, index) {
        items.forEach((item, i) => {
            item.classList.toggle("highlight", i === index);
        });
    }
}


//----------------------------------------------------------------------------------

// Filtrar en tiempo real
document.querySelectorAll("#buscarCuenta, .buscarCuenta").forEach(input => {
    input.addEventListener("input", function() {
        let fila = this.closest('tr').rowIndex; // Obt√©n el √≠ndice de la fila
        console.log("la fila es:  " + fila)
        let filtro = this.value.toLowerCase();
        let cuentasFiltradas = listaCuentas.filter(cuenta =>
            `${cuenta.idPlu} - ${cuenta.nombrePlu}`.toLowerCase().includes(filtro)
        );
        mostrarCuentas(cuentasFiltradas, fila); // Pasamos el n√∫mero de fila din√°micamente
    });
});






//--------------------------------------------------------------------------------------------------------------

function calcularTotales() {
    console.log("Ingres√≥ al calcularTotales");
    let totalDebito = 0, totalCredito = 0;

    // Sumar valores de la columna D√©bito
    document.querySelectorAll("[id^='debito']").forEach(input => {
        totalDebito += parseFloat(input.value) || 0;
    });

    // Sumar valores de la columna Cr√©dito
    document.querySelectorAll("[id^='credito']").forEach(input => {
        totalCredito += parseFloat(input.value) || 0;
    });

    console.log("totalDebito " + totalDebito);
    console.log("totalCredito " + totalCredito);

    // Actualizar los valores en la fila de totales
    document.getElementById("totalDebitoResumen").textContent = totalDebito.toFixed(2);
    document.getElementById("totalCreditoResumen").textContent = totalCredito.toFixed(2);

    // Calcular la diferencia
    let diferencia = totalDebito - totalCredito;
    document.getElementById("diferencia").textContent = diferencia.toFixed(2);

    // Cambiar color seg√∫n la diferencia
    let diferenciaElement = document.getElementById("diferencia");
    diferenciaElement.style.color = diferencia === 0 ? "green" : "red";
}
		
		
		
function GuardarOrdenDeTrabajo() {
    calcularTotalGeneral(); // Asegura que el total est√© actualizado

    let xIdPluArr = [];
    let xNombrePluArr = [];
    let xVrUnitarioArr = [];
    let xIvaArr = [];
    let xCantidadArr = [];
    let xSubtotalArr = [];
    let xExistenciaArr = [];

    let tabla = document.querySelector("#tabla tbody");
    let filas = tabla.querySelectorAll("tr");
    let filasVacias = false;
    
    
    var operario = document.getElementById("operario").value;
    var idCliente = document.getElementById("buscarTercero").getAttribute("data-idTercero");
    var Observacion =  document.getElementById("Observacion").value;
    
    if(operario == "-Seleccione-"){					
		alert("Por favor seleccione un operario");
		return;
	  }
			
			
	if(!idCliente){		
		alert("Por favor seleccione un tercero");
		return;
	}		
				
				

    filas.forEach((fila, index) => {
        let numFila = index + 1; // Para manejar IDs din√°micos

        // Detectar los IDs correctos por fila
        let idBuscarCuenta = numFila === 1 ? "buscarCuenta" : `buscarCuenta${numFila}`;
        let idVrUnitario = numFila === 1 ? "vrUnitario" : `vrUnitario${numFila}`;
        let idIva = numFila === 1 ? "iva" : `iva${numFila}`;
        let idCantidad = numFila === 1 ? "cantidad1" : `cantidad${numFila}`;
        let idSubTotal = numFila === 1 ? "vrSubTotal1" : `vrSubTotal${numFila}`;
        let idExistencia = numFila === 1 ? "existencia1" : `existencia${numFila}`;

        // Obtener los valores
        let inputCuenta = document.getElementById(idBuscarCuenta);
        let idPlu = inputCuenta?.getAttribute("data-idCuenta") || "";
        let nombrePlu = inputCuenta?.value || "";
        let vrUnitario = parseFloat(document.getElementById(idVrUnitario)?.value || 0);
        let iva = parseFloat(document.getElementById(idIva)?.value || 0);
        let cantidad = parseFloat(document.getElementById(idCantidad)?.value || 0);
        let subtotal = parseFloat(document.getElementById(idSubTotal)?.value || 0);
        let existencia = parseFloat(document.getElementById(idExistencia)?.value || 0);

        // Validar fila incompleta
        if (!idPlu || cantidad <= 0 || vrUnitario <= 0) {
            filasVacias = true;
        }

        // Guardar en los arrays
        xIdPluArr.push(idPlu);
        xNombrePluArr.push(nombrePlu);
        xVrUnitarioArr.push(vrUnitario);
        xIvaArr.push(iva);
        xCantidadArr.push(cantidad);
        xSubtotalArr.push(subtotal);
        xExistenciaArr.push(existencia);
    });

    if (filasVacias) {
        swal({
            title: "Error",
            text: "Hay filas incompletas o con valores inv√°lidos. Revisa las cantidades y productos.",
            icon: "error",
            button: "Aceptar",
        });
        return;
    }

    // Total general
    let totalVenta = parseFloat(document.getElementById("ventaTotal")?.textContent || 0);

    // Construir objeto de datos a enviar
    let datos = {
        xIdPluArr,
        xNombrePluArr,
        xVrUnitarioArr,
        xIvaArr,
        xCantidadArr,
        xSubtotalArr,
        xExistenciaArr,
        totalVenta,
        operario,
        idCliente,
        Observacion
    };

    console.log("Datos a enviar:", datos);

    // Enviar al backend
    fetch("./FinalizarOrdenDeTrabajo-Post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos),
    })
     .then(response => {
        // Verificar el c√≥digo de estado de la respuesta
        if (response.ok) {
            // Si la respuesta es exitosa, descargar el archivo
            return response.blob();
        } else {
            // Si la respuesta es un error, mostrar un mensaje al usuario
           // throw new Error('Error PEDIDO, Nota Credito YA CONFIRMADO');
           console.log("Est√° ingresando en el else del response");
        }
    })
    .then(blob => {
        // Crear un objeto URL para el Blob
        const url = URL.createObjectURL(blob);

        // Abrir una nueva ventana para mostrar el archivo
        window.open(url);
        window.location.href = './menuPrincipal';
    })
    .catch(error => {
        // Manejar el error y mostrar un mensaje al usuario
        console.error('Error al descargar el archivo', error);
        alert('Error: ' + error.message);
    });
}
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		/*------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
		
		function ReporteDetalleOrdenDeTrabajo() {
			
			     const button = document.getElementById('consultarBtn');
			     
			     // Deshabilitar el bot√≥n
        		 button.disabled = true;

				 // Mostrar el spinner de carga
                 document.getElementById('loadingSpinner').style.display = 'block';
                                 
				 var idPeriodoInt = document.getElementById("PeriodoReporte").value;
    		     var idPeriodo = idPeriodoInt.toString();
  				 console.log("el tipo de dato de idPeriodo es " + typeof idPeriodo);
  				 
  				 var formato = document.getElementById("formato").value;
				

				// Crear un objeto que contenga los datos a enviar
				var datos = {
					idPeriodo: idPeriodo,
					formato: formato

				};

				// Realizar una solicitud POST al controlador
				fetch("./DescargarReporteDetalleOrdenDeTrabajo", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify(datos),
				})
				.then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.blob();  // Convierte la respuesta a un Blob (secuencia de bytes)
    })
    //---------
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const nombreReporte = "reporteReporteDetalleOrdenDeTrabajo_" + idPeriodo
        
        if (formato === 'PDF') {
			
			const a = document.createElement('a');
            a.href = url;
            a.download = nombreReporte + '.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            // Abrir  PDF 
            window.open(url, '_blank');
        } else if (formato === 'EXCEL') {
            // Descargar Excel
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreReporte + '.xlsx';           
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        // Liberar la URL del objeto para liberar recursos
        window.URL.revokeObjectURL(url);
    })
    //----------
    .catch(error => console.error('Error al descargar el archivo', error))
    .finally(() => {
        // Ocultar el spinner de carga
        document.getElementById('loadingSpinner').style.display = 'none';
        button.disabled = false;
    });

	}	
	
	
		
		
		
 function BuscarTerceros(fila) {
    console.log(`Ingres√≥ a BuscarTerceros en fila ${fila}`);

    fetch("./ObtenerTerceros", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        listaTerceros = data.xListaTerceros; 
        mostrarTerceros(listaTerceros, fila);
    })
    .catch(error => console.error("Error al obtener terceros:", error));
}

function mostrarTerceros(terceros, fila) {
	console.log(`Fila en mostrarTerceros es ${fila}`);

    
    
    // Si es la primera fila, usa los IDs sin n√∫mero
    let resultsContainer = fila === 1 ? document.getElementById("terceros") : document.getElementById(`terceros${fila}`);
    let inputTercero = fila === 1 ? document.getElementById("buscarTercero") : document.getElementById(`buscarTercero${fila}`);

    resultsContainer.innerHTML = "";
    
    if (terceros.length === 0) {
        resultsContainer.style.display = "none";
        return;
    }

    terceros.forEach(tercero => {
        let item = document.createElement("div");
        item.classList.add("result-item");
        item.textContent = `${tercero.idCliente} - ${tercero.nombreTercero}`;
        item.onclick = () => {
            inputTercero.value = `${tercero.idCliente} - ${tercero.nombreTercero}`;
            inputTercero.setAttribute("data-idTercero", tercero.idCliente);
            console.log("idCliente esssss" + tercero.idCliente );
            
            resultsContainer.style.display = "none";
        };
        resultsContainer.appendChild(item);
    });

    resultsContainer.style.display = "block";
}


// Filtrar en tiempo real para terceros
document.getElementById("buscarTercero").addEventListener("input", function() {
    let resultsContainer = document.getElementById("terceros");

    let filtro = this.value.toLowerCase();
    let tercerosFiltrados = listaTerceros.filter(tercero =>
        `${tercero.cc_Nit} - ${tercero.nombreTercero}`.toLowerCase().includes(filtro)
    );

    mostrarTerceros(tercerosFiltrados, 1);
});



// Cerrar el dropdown si se hace clic fuera
document.addEventListener("click", function(event) {
    document.querySelectorAll("input[id^='buscarTercero']").forEach(inputTercero => {
        let fila = inputTercero.id.replace("buscarTercero", ""); // Obtiene el n√∫mero de fila
        let tercerosContainer = document.getElementById(fila ? `terceros${fila}` : "terceros");

        if (tercerosContainer && !inputTercero.contains(event.target) && !tercerosContainer.contains(event.target)) {
            tercerosContainer.style.display = "none";
        }
    });
});



		
	
   function ReporteAbono() {
			
			     const button = document.getElementById('consultarBtn');
			     
			     // Deshabilitar el bot√≥n
        		 button.disabled = true;

				 // Mostrar el spinner de carga
                 document.getElementById('loadingSpinner').style.display = 'block';
                 
                 
   				 var operario = document.getElementById("operario").value;
				 var idPeriodoInt = document.getElementById("xIdPeriodo").value;
				 var Observacion =  document.getElementById("Observacion").value;
				 var idCliente = document.getElementById("buscarTercero").getAttribute("data-idTercero");
				 var formato = "PDF"

    		     var idPeriodo = idPeriodoInt.toString();

				console.log("el tipo de dato de idPeriodo es " + typeof idPeriodo);
				console.log("idCliente es " + idCliente);
				

				
				if(operario == "-Seleccione-"){
					
					alert("Por favor seleccione un operario");
					document.getElementById('loadingSpinner').style.display = 'none';
                    button.disabled = false;
					return;
				}
				
				
				
				if(!Observacion){
					
					alert("Por favor ingresar una observaci√≥n");
					document.getElementById('loadingSpinner').style.display = 'none';
           		    button.disabled = false;
					return;
				}
				


				// Crear un objeto que contenga los datos a enviar
				var datos = {
					operario: operario,
					idPeriodo: idPeriodo,
					Observacion: Observacion,
					idCliente: idCliente
					

				};

				// Realizar una solicitud POST al controlador
				fetch("./DescargarReporteOrdenDeTrabajo", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify(datos),
				})
				.then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.blob();  // Convierte la respuesta a un Blob (secuencia de bytes)
    })
       //---------
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const nombreReporte = "reporteOrdenDeTrabajo_" + idPeriodo
        
        if (formato === 'PDF') {
			
			const a = document.createElement('a');
            a.href = url;
            a.download = nombreReporte + '.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            // Abrir  PDF 
            window.open(url, '_blank');
        } else if (formato === 'EXCEL') {
            // Descargar Excel
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreReporte + '.xlsx';           
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        // Liberar la URL del objeto para liberar recursos
        window.URL.revokeObjectURL(url);
    })
    //----------
    .catch(error => console.error('Error al descargar el archivo', error))
    .finally(() => {
        // Ocultar el spinner de carga
        document.getElementById('loadingSpinner').style.display = 'none';
        button.disabled = false;
    });

	}		


</script>
</body>
</html>