<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
 	<head th:replace ="combo/head.html :: head" ></head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" th:href="@{/styles/login.css}">
        <link rel="stylesheet" type="text/css" th:href="@{/styles/General.css}"> 
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/fuenteColor.css}">  	
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/NavBar.css}"> 
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/ComprobanteContable.css}">
    	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <title> MARKETING</title>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>
<body>
    	<header th:replace="combo/navBar.html :: navbar"></header>
			 <!-- Encabezado general -->
			 		 <!-- Encabezado general -->
	<div class="containerFlex" id="encabezado">
		<div class="local">
			<h2 class="letraBlue" th:replace="combo/comboLocal.html :: comboLocal"></h2>
		</div>
	
		<div class="descripcion"> 
			<h2 class="tituloAFcenter">INGRESO INVENTARIO - COMPRA</h2>
		</div>
		<div class="fechahora">
			<h2 class="letra" th:replace="combo/FechaHoraActual.html :: comboFechaHora">
				
		</div>
		
	</div>
	
		<form class="containerTable">
			
			<div id="cajaprincipal" class="cajaprincipal">
			
					<div id="NombreTercero" class="containerFlexCenter2" style="width: 2000px;">
			
			
						<div class="containerFlexCenterNombre">
			
							<label class="letra" for="estadoTerero" style="margin: 30px;">ESTADO CLIENTE :</label>
							<br>
							<input type="text"maxlength="98"  id="estadoTerero" style="width: 200px; text-align: center; " th:value="${xEstado}" readonly>
						</div>
						
						<div class="containerFlexCenterNombre">
			
							<label class="letra" for="nuid" style="margin: 30px;">NUID:</label>
							<input type="text"maxlength="98"  id="nuid" style="width: 200px; text-align: center; " th:value="${xNuid}" readonly>
						</div>
						
						<div class="containerFlexCenterNombre">
			
							<label class="letra" for="nombreTercero" style="margin: 30px;">NOMBRE CLIENTE:</label>
							<input type="text"maxlength="98"  id="nombreTercero" style="width: 280px; " th:value="${xNombreTercero}" readonly>
						</div>
						
						
						
						<div class="containerFlexCenterNombre">
			
							<label class="letra" for="rutaTercero" style="margin: 30px;">RUTA:</label>
							<input type="text"maxlength="98"  id="rutaTercero" style="width: 200px; text-align: center;" th:value="${xRuta}" readonly>
						</div>
			
			
					</div>
		
			
			</div>
			
			
			
				<div class="tablaContable">
		 <table id="tabla">
        <thead>
            <tr>
                <th>#</th>
                <th>DESCRIPCION</th>
                <th>%IVA</th>
                <th>EXISTENCIA</th>
                <th>CANT.RECIBIDA</th>
                <th>VR.BASE</th> 
                <th>VR.IVA</th> 
                <th>VR.SUBTOTAL</th>             
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>

                <td>
                    <div class="search-container">
                            <input type="text" placeholder="Buscar" id="buscarCuenta" onfocus="BuscarCuentas(1)" autocomplete="off">
                            <span class="icon">üîç</span>
                            <div class="results-container" id="results" style="height: 200px;"></div>
                      </div>
                </td>
                <td>
					<input type="text" style="width: 120px;" id="iva1" readonly>
				</td>
				<td>
					<input type="number" value="0.00"  style="width: 80px;" id="existencia1" readonly>
				</td>
                <td>
					<input type="number" value="0.00" style="width: 80px;" id="cantidad1" >
				</td>
				
				 <td>
					<input type="text" style="width: 120px;" id="vrBase1" oninput="actualizarVrIva(1)">
				</td>
				
				<td>
					<input type="text" style="width: 120px;" id="vrIva1" readonly>
				</td>
				
				<td>
					<input type="text" style="width: 120px;" id="vrSubTotal1" readonly>
				</td>
				
				

				<td>
                  <div class="credito-container">
                   <span class="icon save-icon" style="margin-left: 8px;" onclick="agregarFila()">
					   <i class="fas fa-save" ></i>
				   </span>
                   <span class="icon delete-icon" style="margin-left: 8px;">
					   <i class="fas fa-trash-alt"></i>
				   </span>
                 </div>
               </td>
            </tr>
        </tbody>
    </table>
    
    <div class="totals-row" >
        <div class="empty-space"></div>
        <div class="totales">
		   <div class="total-debito" >
			<strong>Total:</strong> 
		  </div>
		  <div class="total-debito" style="margin-left: 10px">
			<span id="ventaTotal">0.00</span>
		  </div>
		  <div class="total-debito">
			<span id="totalCreditoResumen"></span>
		  </div>
		  <div class="total-debito">
			<span id="totalCreditoResumen"></span>
		  </div>
			
		</div>

    </div>

		
	</div>
	
	
	
	
<!-- üîπ Tabla de resumen proveedor -->
<table id="tablaResumen" border="1" style="margin-top: 20px; width: 100%; text-align: center; margin-top: 100px;">
    <thead>
        <tr>
            <th>FACTURA PROVEEDOR</th>
            <th>#. FACTURA</th>
            <th>FECHA. RECIBO</th>
            <th>FECHA. FACTURA</th>
            <th>VR. BASE</th>
            <th>VR. IVA</th>
            <th>VR. TOTAL</th>
            
        </tr>
    </thead>
    <tbody>
        <!-- Fila manual -->
        <tr>
            <td><strong>Factura Proveedor</strong></td>
            <td><input type="text" id="numeroFactura"  style="width:120px;" oninput="compararFactura()"></td>
            <td>
                <input type="date" id="fechaRecibido" name="FechaInicial" th:value="${xFechaActual}"  pattern="\d{4}-\d{2}-\d{2}T\d{2}:\d{2}" required>
            </td>
            <td><input type="text" id="fechaFactura" th:value="${xFechaActual}" style="width:120px;" readonly></td>
            <td><input type="number" id="vrBaseProveedor" value="0" style="width:120px;" oninput="compararFactura()"></td>
            <td><input type="number" id="vrIvaProveedor" value="0" style="width:120px;" oninput="compararFactura()"></td>
            <td><input type="number" id="vrTotalProveedor" value="0" style="width:120px;" oninput="compararFactura()"></td>
        </tr>
        <!-- Fila sistema -->
        <tr>
            <td><strong>Sistema</strong></td>
            <td><span ></span></td>
            <td><span ></span></td>
            <td><span ></span></td>
            <td><span id="vrBaseSistema">0.00</span></td>
            <td><span id="vrIvaSistema">0.00</span></td>
            <td><span id="vrTotalSistema">0.00</span></td>
        </tr>
        <!-- Fila diferencia -->
        <tr>
            <td><strong>Diferencia</strong></td>
            <td><span ></span></td>
            <td><span ></span></td>
            <td><span ></span></td>
            <td><span id="difBase">0.00</span></td>
            <td><span id="difIva">0.00</span></td>
            <td><span id="difTotal">0.00</span></td>
        </tr>
    </tbody>
</table>
			
			
			


				
			<div class="GenerarReporte" style="margin-top: 60px;">
					<a href="./menuPrincipal" class="btn btn-success" >Regresar</a>
					<button type="button" class="btn btn-success" value="Guardar" style="width: 100px; margin-left: 50px;" onclick="GuardarCompra()" >Finalizar</button>
			</div>

		</form>
	<div>
		
		
	</div>
	
	
	
	
	
	
	

    <script th:inline="javascript" src="./js/contadorRegresivo.js"></script>
    <script th:inline="javascript">
		
		
		
// ‚úÖ Calcula IVA y subtotal de una fila
function actualizarVrIva(filaNum) {
  let idVrBase   = filaNum === 1 ? "vrBase1"   : `vrBase${filaNum}`;
  let idIva      = filaNum === 1 ? "iva1"      : `iva${filaNum}`;
  let idVrIva    = filaNum === 1 ? "vrIva1"    : `vrIva${filaNum}`;
  let idVrSubTotal = filaNum === 1 ? "vrSubTotal1" : `vrSubTotal${filaNum}`;

  let vrBase = parseFloat(document.getElementById(idVrBase)?.value || 0);
  let ivaPct = parseFloat(document.getElementById(idIva)?.value || 0);

  // Calcular IVA y subtotal
  let vrIva = (vrBase * ivaPct) / 100;
  let vrSubTotal = vrBase + vrIva;

  // Actualizar en los inputs
  document.getElementById(idVrIva).value = vrIva.toFixed(2);
  document.getElementById(idVrSubTotal).value = vrSubTotal.toFixed(2);

  // Recalcular totales generales
  calcularTotalesSistema();
  
  calcularTotalGeneral();
}


// üîπ Recalcula el total de todas las filas
function calcularTotalGeneral() {
  let tabla = document.querySelector("#tabla tbody");
  let filas = tabla.querySelectorAll("tr");

  let total = 0;

  filas.forEach(function(fila, index) {
    let filaNum = index + 1;
    let idVrSubTotal = filaNum === 1 ? "vrSubTotal1" : `vrSubTotal${filaNum}`;

    let vrSubTotal = parseFloat(document.getElementById(idVrSubTotal)?.value || 0);
    total += vrSubTotal;
  });

  document.getElementById("ventaTotal").textContent = total.toFixed(2);
}


// ‚úÖ Recalcula el total general del sistema y guarda el valor sin formato en data-value
function calcularTotalesSistema() {
  let tabla = document.querySelector("#tabla tbody");
  let filas = tabla.querySelectorAll("tr");

  let totalBase = 0;
  let totalIva = 0;
  let totalGeneral = 0;

  filas.forEach(function(fila, index) {
    let filaNum = index + 1;
    let idVrBase     = filaNum === 1 ? "vrBase1"     : `vrBase${filaNum}`;
    let idVrIva      = filaNum === 1 ? "vrIva1"      : `vrIva${filaNum}`;
    let idVrSubTotal = filaNum === 1 ? "vrSubTotal1" : `vrSubTotal${filaNum}`;

    let vrBase = parseFloat(document.getElementById(idVrBase)?.value || 0);
    let vrIva  = parseFloat(document.getElementById(idVrIva)?.value || 0);
    let vrSubTotal = parseFloat(document.getElementById(idVrSubTotal)?.value || 0);

    totalBase += vrBase;
    totalIva += vrIva;
    totalGeneral += vrSubTotal;
  });

  // Actualizar en resumen: mostrar formateado pero guardar valor raw en data-value
  const elBaseSistema = document.getElementById("vrBaseSistema");
  const elIvaSistema  = document.getElementById("vrIvaSistema");
  const elTotalSistema= document.getElementById("vrTotalSistema");

  if (elBaseSistema) {
    elBaseSistema.textContent = totalBase.toLocaleString();
    elBaseSistema.dataset.value = totalBase; // raw value
  }
  if (elIvaSistema) {
    elIvaSistema.textContent = totalIva.toLocaleString();
    elIvaSistema.dataset.value = totalIva;
  }
  if (elTotalSistema) {
    elTotalSistema.textContent = totalGeneral.toLocaleString();
    elTotalSistema.dataset.value = totalGeneral;
  }

  // Comparar con lo digitado por proveedor
  compararFactura();
}


// ‚úÖ Compara valores digitados vs sistema usando los valores RAW almacenados en data-value
function compararFactura() {
  // Valores que digita el usuario (inputs => valores no formateados)
  let baseProveedor = parseFloat(document.getElementById("vrBaseProveedor")?.value || 0);
  let ivaProveedor  = parseFloat(document.getElementById("vrIvaProveedor")?.value || 0);
  let totalProveedor= parseFloat(document.getElementById("vrTotalProveedor")?.value || 0);

  // Valores del sistema: leemos el data-value (raw) para evitar problemas de formato
  let baseSistema = parseFloat(document.getElementById("vrBaseSistema")?.dataset.value || 0);
  let ivaSistema  = parseFloat(document.getElementById("vrIvaSistema")?.dataset.value || 0);
  let totalSistema= parseFloat(document.getElementById("vrTotalSistema")?.dataset.value || 0);

  // Diferencias num√©ricas
  const difBase  = baseProveedor - baseSistema;
  const difIva   = ivaProveedor  - ivaSistema;
  const difTotal = totalProveedor - totalSistema;

  // Actualizar en pantalla (formateado)
  const elDifBase  = document.getElementById("difBase");
  const elDifIva   = document.getElementById("difIva");
  const elDifTotal = document.getElementById("difTotal");

  if (elDifBase)  elDifBase.textContent  = difBase.toLocaleString();
  if (elDifIva)   elDifIva.textContent   = difIva.toLocaleString();
  if (elDifTotal) elDifTotal.textContent = difTotal.toLocaleString();

  // ‚ú≥Ô∏è Opcional: marcar en rojo cuando la diferencia sea distinta de 0
  const rowDif = elDifTotal?.closest('tr'); // la fila donde est√° la diferencia (si existe)
  if (rowDif) {
    if (Math.abs(difTotal) > 0.0001 || Math.abs(difBase) > 0.0001 || Math.abs(difIva) > 0.0001) {
      rowDif.style.border = "2px solid red";
      rowDif.style.backgroundColor = "#fff6f6";
    } else {
      rowDif.style.border = "";
      rowDif.style.backgroundColor = "";
    }
  }
}
		
		
		
		
		
		
		
		
	let listaCuentas = []; // Almacena todas las cuentas 
let listaTerceros = [];

// Resstablecer valores
 function restablecerValor(input) {
    if (input.value < 0 || input.value === "") {
        input.value = "0.00"; // Restablecer a 0 si el valor es negativo o vac√≠o
    }
}

// Cerrar el dropdown si se hace clic fuera
document.addEventListener("click", function(event) {
    // Selecciona todos los inputs y contenedores de b√∫squeda
    document.querySelectorAll("input[id^='buscarCuenta']").forEach(inputCuenta => {
        let fila = inputCuenta.id.replace("buscarCuenta", ""); // Obtiene el n√∫mero de fila
        let resultsContainer = document.getElementById(fila ? `results${fila}` : "results");

        if (resultsContainer && !inputCuenta.contains(event.target) && !resultsContainer.contains(event.target)) {
            resultsContainer.style.display = "none";
        }
    });

    document.querySelectorAll("input[id^='buscarTercero']").forEach(inputTercero => {
        let fila = inputTercero.id.replace("buscarTercero", ""); // Obtiene el n√∫mero de fila
        let tercerosContainer = document.getElementById(fila ? `terceros${fila}` : "terceros");

        if (tercerosContainer && !inputTercero.contains(event.target) && !tercerosContainer.contains(event.target)) {
            tercerosContainer.style.display = "none";
        }
    });
});

function agregarFila() {
    let tabla = document.querySelector(".tablaContable tbody");

    // Tomamos la √∫ltima fila de la tabla (si existe)
    if (tabla.rows.length > 0) {
        let ultimaFila = tabla.rows[tabla.rows.length - 1];
        let numFilaUltima = tabla.rows.length; // n√∫mero de la √∫ltima fila

        let cantidad = parseFloat(document.getElementById(`cantidad${numFilaUltima}`).value) || 0;
        let vrBase = parseFloat(document.getElementById(`vrBase${numFilaUltima}`).value) || 0;

        if (cantidad === 0 || vrBase === 0) {
            alert("‚ö†Ô∏è No puedes agregar una nueva fila si la cantidad o el valor base son 0.");
            return; // detenemos la ejecuci√≥n
        }
    }

    // Si pasa la validaci√≥n, ahora s√≠ creamos la nueva fila
    let nuevaFila = document.createElement("tr");
    let numFila = tabla.rows.length + 1;

    nuevaFila.innerHTML = `
        <td>${numFila}</td>
        <td>
            <div class="search-container">
                <input type="text" placeholder="Buscar" id="buscarCuenta${numFila}" 
                       onfocus="BuscarCuentas(${numFila})" autocomplete="off">
                <span class="icon">üîç</span>
                <div class="results-container" id="results${numFila}" style="height: 200px;"></div>
            </div>
        </td>
        <td><input type="text" style="width: 120px;" id="iva${numFila}" readonly></td>
        <td><input type="number" value="0.00" style="width: 80px;" id="existencia${numFila}" readonly></td>
        <td><input type="number" value="0.00" style="width: 80px;" id="cantidad${numFila}"></td>				
        <td><input type="text" style="width: 120px;" id="vrBase${numFila}" oninput="actualizarVrIva(${numFila})"></td>
        <td><input type="text" style="width: 120px;" id="vrIva${numFila}" readonly></td>
        <td><input type="text" style="width: 120px;" id="vrSubTotal${numFila}" readonly></td>
        <td>
            <div class="credito-container">
                <span class="icon save-icon" style="margin-left: 8px;" onclick="agregarFila()">
                    <i class="fas fa-save"></i>
                </span>
                <span class="icon delete-icon" style="margin-left: 8px;" onclick="eliminarFila(this)">
                    <i class="fas fa-trash-alt"></i>
                </span>
            </div>
        </td>
    `;

    tabla.appendChild(nuevaFila);

    // A√±adir event listener para b√∫squeda din√°mica
    const inputCuentaNuevo = nuevaFila.querySelector(`#buscarCuenta${numFila}`);
    inputCuentaNuevo.addEventListener("input", function () {
        let fila = this.closest('tr').rowIndex;
        let filtro = this.value.toLowerCase();
        let cuentasFiltradas = listaCuentas.filter(cuenta =>
            `${cuenta.idCuentaAux} - ${cuenta.nombreCuenta}`.toLowerCase().includes(filtro)
        );
        mostrarCuentas(cuentasFiltradas, fila);
    });

    calcularTotales();
}


// Actualizaci√≥n de las funciones para recibir un par√°metro din√°mico (n√∫mero de fila)
function BuscarCuentas(fila) {
    console.log(`Ingres√≥ a BuscarCuentas en fila ${fila}`);

    fetch("./ObtenerCuentas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        listaCuentas = data.xlistaCuentas; 
        mostrarCuentas(listaCuentas, fila); // Pasamos la fila para saber d√≥nde actualizar
    })
    .catch(error => console.error("Error al obtener cuentas:", error));
}

function mostrarCuentas(cuentas, fila) {
    console.log(`Fila en mostrarCuentas es ${fila}`);

    // Si es la primera fila, usa los IDs sin n√∫mero
    let resultsContainer = fila === 1 ? document.getElementById("results") : document.getElementById(`results${fila}`);
    let inputCuenta = fila === 1 ? document.getElementById("buscarCuenta") : document.getElementById(`buscarCuenta${fila}`);
    let inputIva = fila === 1 ? document.getElementById("iva1") : document.getElementById(`iva${fila}`);
    let inputExistencia = fila === 1 ? document.getElementById("existencia1") : document.getElementById(`existencia${fila}`);

    resultsContainer.innerHTML = "";

    if (cuentas.length === 0) {
        resultsContainer.style.display = "none";
        return;
    }

    cuentas.forEach(cuenta => {
        let item = document.createElement("div");
        item.classList.add("result-item");
        item.textContent = `${cuenta.idPlu} - ${cuenta.nombrePlu}`;
        item.onclick = () => {
            inputCuenta.value = `${cuenta.idPlu} - ${cuenta.nombrePlu}`;
            inputCuenta.setAttribute("data-idCuenta", cuenta.idPlu);
            inputIva.value = `${cuenta.porcentajeIva}`;
            inputExistencia.value = `${cuenta.existencia}`;
            
            resultsContainer.style.display = "none";
        };
        resultsContainer.appendChild(item);
    });

    resultsContainer.style.display = "block";
    
    enableKeyboardNavigation(inputCuenta, resultsContainer);
}

// Misma l√≥gica aplicada a `BuscarTerceros`
function BuscarTerceros(fila) {
    console.log(`Ingres√≥ a BuscarTerceros en fila ${fila}`);

    fetch("./ObtenerTerceros", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        listaTerceros = data.xListaTerceros; 
        mostrarTerceros(listaTerceros, fila);
    })
    .catch(error => console.error("Error al obtener terceros:", error));
}

function mostrarTerceros(terceros, fila) {
	console.log(`Fila en mostrarTerceros es ${fila}`);
  //  let resultsContainer = document.getElementById(`terceros${fila}`);
    
    
    // Si es la primera fila, usa los IDs sin n√∫mero
    let resultsContainer = fila === 1 ? document.getElementById("terceros") : document.getElementById(`terceros${fila}`);
    let inputTercero = fila === 1 ? document.getElementById("buscarTercero") : document.getElementById(`buscarTercero${fila}`);

    resultsContainer.innerHTML = "";
    
    if (terceros.length === 0) {
        resultsContainer.style.display = "none";
        return;
    }

    terceros.forEach(tercero => {
        let item = document.createElement("div");
        item.classList.add("result-item");
        item.textContent = `${tercero.cc_Nit} - ${tercero.nombreTercero}`;
        item.onclick = () => {
            inputTercero.value = `${tercero.cc_Nit} - ${tercero.nombreTercero}`;
            inputTercero.setAttribute("data-idTercero", tercero.cc_Nit);
            console.log("CC_NIT esssss" + tercero.cc_Nit );
            
            resultsContainer.style.display = "none";
        };
        resultsContainer.appendChild(item);
    });

    resultsContainer.style.display = "block";
}

// Funci√≥n para eliminar filas din√°micamente
function eliminarFila(elemento) {
    let fila = elemento.closest("tr");
    fila.remove();

    // Recalcular los n√∫meros de fila despu√©s de eliminar
    let filas = document.querySelectorAll(".tablaContable tbody tr");
    filas.forEach((fila, index) => {
        fila.children[0].textContent = index + 1;
    });
}


//--------------------------------- PERMITE NAVEGAR EN LOS RESULTADOS DEL DIV QUE MUESTRA LAS CUENTAS BUSCADAS

function enableKeyboardNavigation(input, container) {
    let currentIndex = -1;

    input.addEventListener("keydown", function (e) {
        const items = container.querySelectorAll(".result-item");

        if (e.key === "ArrowDown") {
            e.preventDefault();
            if (currentIndex < items.length - 1) {
                currentIndex++;
                updateHighlight(items, currentIndex);
            }
        } else if (e.key === "ArrowUp") {
            e.preventDefault();
            if (currentIndex > 0) {
                currentIndex--;
                updateHighlight(items, currentIndex);
            }
        } else if (e.key === "Enter") {
            e.preventDefault();
            if (currentIndex >= 0 && currentIndex < items.length) {
                items[currentIndex].click(); // simula clic
                currentIndex = -1; // reinicia
            }
        }
    });

    function updateHighlight(items, index) {
        items.forEach((item, i) => {
            item.classList.toggle("highlight", i === index);
        });
    }
}


//----------------------------------------------------------------------------------

// Filtrar en tiempo real
document.querySelectorAll("#buscarCuenta, .buscarCuenta").forEach(input => {
    input.addEventListener("input", function() {
        let fila = this.closest('tr').rowIndex; // Obt√©n el √≠ndice de la fila
        console.log("la fila es:  " + fila)
        let filtro = this.value.toLowerCase();
        let cuentasFiltradas = listaCuentas.filter(cuenta =>
            `${cuenta.idCuentaAux} - ${cuenta.nombreCuenta}`.toLowerCase().includes(filtro)
        );
        mostrarCuentas(cuentasFiltradas, fila); // Pasamos el n√∫mero de fila din√°micamente
    });
});


document.querySelectorAll("#buscarTercero, .buscarTercero").forEach(input => {
    input.addEventListener("input", function() {
        let fila = this.closest('tr').rowIndex; // Obt√©n el √≠ndice de la fila
        console.log("la fila es:  " + fila)
        let filtro = this.value.toLowerCase();
        let tercerosFiltrados = listaTerceros.filter(tercero =>
            `${tercero.cc_Nit} - ${tercero.nombreTercero}`.toLowerCase().includes(filtro)
        );
        mostrarTerceros(tercerosFiltrados, fila); // Pasamos el n√∫mero de fila din√°micamente
    });
});





//--------------------------------------------------------------------------------------------------------------

function calcularTotales() {
    console.log("Ingres√≥ al calcularTotales");
    let totalDebito = 0, totalCredito = 0;

    // Sumar valores de la columna D√©bito
    document.querySelectorAll("[id^='debito']").forEach(input => {
        totalDebito += parseFloat(input.value) || 0;
    });

    // Sumar valores de la columna Cr√©dito
    document.querySelectorAll("[id^='credito']").forEach(input => {
        totalCredito += parseFloat(input.value) || 0;
    });

    console.log("totalDebito " + totalDebito);
    console.log("totalCredito " + totalCredito);

    // Actualizar los valores en la fila de totales
    document.getElementById("totalDebitoResumen").textContent = totalDebito.toFixed(2);
    document.getElementById("totalCreditoResumen").textContent = totalCredito.toFixed(2);

    // Calcular la diferencia
    let diferencia = totalDebito - totalCredito;
    document.getElementById("diferencia").textContent = diferencia.toFixed(2);

    // Cambiar color seg√∫n la diferencia
    let diferenciaElement = document.getElementById("diferencia");
    diferenciaElement.style.color = diferencia === 0 ? "green" : "red";
}


 /*<![CDATA[*/
    let listaIdDctoNitcc = [[${xListaIdDctoNitcc}]];
    /*]]>*/


function GuardarCompra() {
    calcularTotalGeneral(); // Asegura que el total est√© actualizado

    let xIdPluArr = [];
    let xNombrePluArr = [];
    let xIvaArr = [];
    let xCantidadArr = [];
    let xSubtotalArr = [];
    let xVrBaseArr = [];

    let tabla = document.querySelector("#tabla tbody");
    let filas = tabla.querySelectorAll("tr");
    let filasVacias = false;
    
    let numeroFactura =  document.getElementById("numeroFactura").value;
    let fechaRecibido =  document.getElementById("fechaRecibido").value;
    
    let vrBaseSistema = document.getElementById("vrBaseSistema").textContent;
    let vrIvaSistema  = document.getElementById("vrIvaSistema").textContent;
    
    let difBase  = document.getElementById("difBase").textContent;
    let difIva  = document.getElementById("difIva").textContent;
    let difTotal  = document.getElementById("difTotal").textContent;

	// üîπ Eliminar puntos de miles y comas, dejar solo formato decimal est√°ndar
	vrBaseSistema = vrBaseSistema.replace(/\./g, "").replace(",", ".");
	vrIvaSistema  = vrIvaSistema.replace(/\./g, "").replace(",", ".");



	if (numeroFactura === 0 || numeroFactura === "") {
            alert("‚ö†Ô∏è Debes de asignar un numero de factura");
            return; 
       }
       
       
       
     //Validar si existe en la lista
    if (listaIdDctoNitcc.includes(numeroFactura)) {
      alert("‚ö†Ô∏è La factura N¬∞ " + numeroFactura + " ya existe en el sistema.");
      return;
    }
       
       
     if (difBase != 0 ) {
            alert("‚ö†Ô∏è La diferencia de Valor Base debe ser 0");
            return; 
       }
       
       
     if (difIva != 0 ) {
            alert("‚ö†Ô∏è La diferencia de Valor Iva debe ser 0");
            return; 
       }
       
      if (difTotal != 0 ) {
            alert("‚ö†Ô∏è La diferencia de Valor Total debe ser 0");
            return; 
       }
    
    


    filas.forEach((fila, index) => {
        let numFila = index + 1; // Para manejar IDs din√°micos

        // Detectar los IDs correctos por fila
        let idBuscarCuenta = numFila === 1 ? "buscarCuenta" : `buscarCuenta${numFila}`;
        let idIva = numFila === 1 ? "iva1" : `iva${numFila}`;
        let idCantidad = numFila === 1 ? "cantidad1" : `cantidad${numFila}`;
        let idSubTotal = numFila === 1 ? "vrSubTotal1" : `vrSubTotal${numFila}`;
        let idVrBase = numFila === 1 ? "vrBase1" : `vrBase${numFila}`;

        // Obtener los valores
        let inputCuenta = document.getElementById(idBuscarCuenta);
        let idPlu = inputCuenta?.getAttribute("data-idCuenta") || "";
        let nombrePlu = inputCuenta?.value || "";
        let iva = parseFloat(document.getElementById(idIva)?.value || 0);
        let cantidad = parseFloat(document.getElementById(idCantidad)?.value || 0);
        let subtotal = parseFloat(document.getElementById(idSubTotal)?.value || 0);
        let vrBase = parseFloat(document.getElementById(idVrBase)?.value || 0);

        // Validar fila incompleta
        if (!idPlu || cantidad <= 0 || vrBase <= 0) {
            filasVacias = true;
        }

        // Guardar en los arrays
        xIdPluArr.push(idPlu);
        xNombrePluArr.push(nombrePlu);
        xIvaArr.push(iva);
        xCantidadArr.push(cantidad);
        xSubtotalArr.push(subtotal);
        xVrBaseArr.push(vrBase);
    });

    if (filasVacias) {
        swal({
            title: "Error",
            text: "Hay filas incompletas o con valores inv√°lidos. Revisa las cantidades y productos.",
            icon: "error",
            button: "Aceptar",
        });
        return;
    }

    // Total general
    let totalVenta = parseFloat(document.getElementById("ventaTotal")?.textContent || 0);

    // Construir objeto de datos a enviar
    let datos = {
        xIdPluArr,
        xNombrePluArr,
        xIvaArr,
        xCantidadArr,
        xSubtotalArr,
        xVrBaseArr,
        totalVenta,
        numeroFactura,
        fechaRecibido,
        vrBaseSistema,
        vrIvaSistema
    };

    console.log("Datos a enviar:", datos);

    // Enviar al backend
    fetch("./FinalizarCompra-Post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos),
    })
     .then(response => {
        // Verificar el c√≥digo de estado de la respuesta
        if (response.ok) {
            // Si la respuesta es exitosa, descargar el archivo
            return response.blob();
        } else {
            // Si la respuesta es un error, mostrar un mensaje al usuario
           // throw new Error('Error PEDIDO, Nota Credito YA CONFIRMADO');
           console.log("Est√° ingresando en el else del response");
        }
    })
    .then(blob => {
        // Crear un objeto URL para el Blob
        const url = URL.createObjectURL(blob);

        // Abrir una nueva ventana para mostrar el archivo
        window.open(url);
        window.location.href = './menuPrincipal';
    })
    .catch(error => {
        // Manejar el error y mostrar un mensaje al usuario
        console.error('Error al descargar el archivo', error);
        alert('Error: ' + error.message);
    });
}
		
		
		
		

	
	

	
	
	
	function retirarItem(item){
			
			console.log("item es : " + item );
			
			var idLog = document.getElementById("xIdLog").value;
			
	// Crear un objeto que contenga los datos a enviar
		var datos = {
				item: item,
				idLog: idLog
		};


		// Realizar una solicitud POST al controlador
		fetch("./RetirarItem", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify(datos),
		})

   .then((response) => {
            // Parsea la respuesta JSON
            return response.json();
        })
        .then((data) => {
            var message = data.message;
            console.log(message);
            // Redirige a la URL especificada en la respuesta
            window.location.href = data.redirectUrl;
        })
        .catch((error) => {
            console.error("Error al registrar el log:", error);
        });
			
			
			
		}

			
	
	</script>
</body>
</html>